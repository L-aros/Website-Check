# 配置说明

本文分两类配置：
- 后端运行所需的环境变量（`backend/.env`）
- 前端管理界面中的“系统设置/任务设置”（影响抓取、链接监控、附件下载）

## 1. 后端环境变量（backend/.env）

### 1.1 基础与安全（生产环境必填）
- `NODE_ENV`：生产环境设置为 `production`
- `PORT`：后端端口（默认 3000）
- `ADMIN_PASSWORD`：管理端登录密码
- `JWT_SECRET`：JWT 签名密钥（务必随机且保密）

### 1.2 数据库（生产环境必填）
本项目支持两种数据库模式：MySQL（默认）与 SQLite（单机）。通过 `DB_DIALECT` 切换。

MySQL（默认）：
- `DB_DIALECT=mysql`
- `DB_HOST`：MySQL 地址
- `DB_NAME`：数据库名
- `DB_USER`：用户名
- `DB_PASS`：密码

SQLite（单机部署/轻量部署）：
- `DB_DIALECT=sqlite`
- `DB_STORAGE`：SQLite 文件路径，例如 `./data/website_check.sqlite`
  - 说明：SQLite 适合单机部署；不建议多实例同时写入同一个 SQLite 文件。

### 1.3 稳定性（推荐）
- `MAX_CONCURRENT_CHECKS`：全局同时执行的监控检查数上限（默认 2）
  - 任务多/频率高时建议设置 1–4；过大可能触发 Puppeteer 资源耗尽

### 1.4 数据库表同步策略（谨慎）
默认使用 `sequelize.sync()`（不会自动变更表结构）。
- `DB_SYNC_ALTER=true`：仅在非生产环境启用 `sync({ alter: true })`
- `DB_SYNC_FORCE=true`：强制 `sync({ force: true })`（会清空表，危险）

### 1.5 通知（按需配置）
邮件（启用邮件通知才需要）：
- `SMTP_HOST`、`SMTP_PORT`、`SMTP_USER`、`SMTP_PASS`、`SMTP_SECURE`

短信（启用短信通知才需要，具体依赖供应商实现）：
- `ADMIN_PHONE`
- `SMS_PRIMARY_PROVIDER`、`SMS_FALLBACK_PROVIDER`
- `PUBLIC_WEB_URL`
- `VOLC_SMS_TEMPLATE_HAS_PARAMS`

## 2. 系统设置（/settings）

### 2.1 新增链接时自动查找并下载附件
- 作用：当任务启用了“监控页面链接变化”后，系统会维护该页面的“文章链接集合”。当检测到新增链接时，会进入新增文章页扫描附件并尝试下载，同时把附件纳入后续状态监控与日志。
- 默认：关闭

### 2.2 每次最多处理新增链接数
- 作用：限制单次检查要进入多少个新增链接页面，避免一次新增很多链接导致检查超时。
- `0`：只记录新增链接，不进入链接页面抓取。
- 说明：首次启用该功能时，也会按该限额处理当前页面已存在的链接（作为基线初始化）。

### 2.3 附件日期过滤（仅监控该日期之后）
- 作用：当附件响应包含 `Last-Modified` 时，仅保留修改时间晚于该日期的附件；早于该日期的附件会被标记为已过滤，不下载。
- 支持格式：
  - `YYYY-MM-DD`（按 UTC 00:00:00 解析）
  - ISO 时间（例如 `2026-02-06T12:00:00+08:00`）
  - 时间戳（秒或毫秒，例如 `1738800000` / `1738800000000`）
- 为空：不限制

### 2.4 附件监控日志级别
- 可选：`error` / `warn` / `info` / `debug`
- 说明：设置为 `info` 时会记录 `error/warn/info`，不会记录 `debug`。

## 3. 任务设置关键项（创建/编辑任务）

### 3.1 选择器类型与选择器
- `selectorType`：`css` / `xpath`
- `selector`：用于提取需要监控的内容（文本）；或用于辅助抽取链接（当开启链接监控时）

### 3.2 监控页面链接变化
- 开启后：该任务的“监控内容”会变为链接集合（而不是选择器文本），用于识别“新增链接”。

### 3.3 文章链接范围选择器（可选）
- 用途：只在某个容器内抽取文章链接，避免把导航栏、页脚、logo 等无关链接也纳入“链接集合”。

### 3.4 新增链接时查找并下载附件
- 需要同时满足：
  - 系统设置开启“新增链接时自动查找并下载附件”
  - 任务启用该选项
  - 配置了允许的附件后缀（见下文）

### 3.5 自动下载附件（当前页面）
- 作用：从“当前被监控页面”直接下载符合后缀的链接（适合附件直接挂在公告页/列表页）。

### 3.6 允许的附件后缀（attachmentTypes）
- 逗号分隔，不带点，例如：`pdf,doc,docx,xls,xlsx,zip,rar`
- 说明：附件发现/下载严格按这个白名单执行，不会把网站图标、图片等资源当作附件。

### 3.7 命中规则（matchType / matchPattern，可选）
- 用途：当页面内容发生变化时，只有“命中规则”的变化才会被记录为历史并发送通知；未命中会直接忽略（但仍会更新最新 hash，避免重复触发）。
- `matchType`：
  - `none`：不启用（默认）
  - `keyword`：关键词包含
  - `regex`：正则匹配
- `matchPattern`：关键词或正则表达式内容
- `matchIgnoreCase`：是否忽略大小写（默认 true）
